# NTFS 구조

![MFT.jpg](https://images.velog.io/post-images/jjewqm/d8300230-1339-11ea-beaf-633be8e6e180/MFT.jpg)

NTFS는 VBR영역, MFT영역, 데이터 영역으로 구성되어 있다. VBR 영역은 부트섹터와 추가적인 부트코드가 저장된다.

MFT 영역은 고정되어 있지 않다. MFT 영역의 크기는 미리 예측할 수 없기 때문에 VBR영역에 고정적으로 위치해 있지 않다. 볼륨에 파일 및 디렉터리가 많아 질수록 데이터 영역에 조각나 저장될 수 있다.
따라서 초기 포맷 시에 일정 영역만 MFT를 위한 여역으로 할당된다. MFT에는 파일 및디렉터리마다 하나 이상의 MFT Entry가 할당되 생성될 파일 및 디렉터리 수를 미리 예측할 수 없다. 따라서 미리 할당된 MFT 영역을 모두 사용해 더 필요하면 데이터 영역을 추가할당하여 사용한다.

MFT영역은 파일과 디렉터리를 관리하기 위한 MFT entry의 집합체다. MFT영역은 그 자체를 하나의 파일로 고려하기 때문에 데이터 여영ㄱ과 구별되지않고 뒤섞여있다.

DATA 영역은 파일의 실제 내용이 저장되는 공간이다. 모든 관련 정보는 MFT Entry의 속성을 통해 관리되므로 특별한 구조 없이 내용만 저장한다.

## MFT 개념

MFT(Master File TAble)은 모든 파일들과 디렉토리 정보를 포함한다.
모든 파일과 디렉토리는 테이블에 한 엔트리를 반드시 갖는다.
엔트리 크기는 1KB이고, 첫 42바이트는 미리 정의된다. 나머지 바이트들은 특정 목적을 갖는 작은 데이터 구조체로 이루어진 속성들을 저장한다.

- MFT 엔트리 레이아웃

![MFT 엔트리 레이아웃.png](https://images.velog.io/post-images/jjewqm/f5940190-419d-11ea-8326-297e8089ed4c/MFT-엔트리-레이아웃.png)

예를들어 한 속성은 파일명을 저장하고 다른 속성은 파일 내용을 저장한다.
각 엔트리는 테이블에서 위치를 나타내는 한 개의 주소를 갖고, 0으로 시작한다.
모든 엔트리 크기가 1,024바이트지만 정확한 크기는 부트 섹터에서 정의한다.
MFT는 `한 파일`이며 `MFT`를 관리하는 자체 엔트리를 하나 갖는다.
MFT 첫 번째 엔트리는 $MFT이다. 이것은 MFT의 `디스크 위치`를 설명한다. 
`디스크 위치`란 파일시스템에서 MFT의 섹터위치를 설명하는 장소이다.
MFT의 레이아웃과 크기를 결정하기 위해서는 $MFT를 해석해야 한다.
MFT 시작 위치는 파일시스템의 첫 번째 섹터에 위치한 부트 섹터에서 알 수 있다.
MFT는 FAT처럼 연속적인 섹터 그룹인 클러스터를 사용하며 단편화 되어 있다.
MS는 NTFS를 구현할 때 MFT를 가능한 작게 시작하고, 더욱 많은 엔트리가 필요할 때는 크기를 확장하도록 구현했다. 이론적으로 운영체제는 파일시스템을 생성할 때 고정된 수의 엔트리를 생성하지만 MS는 볼륨 스패닝에서 더 큰 공간이 더해질 때 동적으로 파일시스템을 크게 만들 수 있도록 구현했다. 그리고 MFT 엔트리들은 생성된 후 지워지지 않는다.

## MFT 엔트리 내용

MFT엔트리 크기는 1,024 바이트이다. 데이터 구조체 첫 42바이트는 12개 필드를 포함하고, 나머지 982 바이트는 비구조적으로 속성 값들을 가진다.
MFT 엔트리를 택배 박스와 같다.
박스 겉면에는 이름과 주소 같은 기본 정보가 있다. 이 정보는 MFT 엔트리의 고정된 필드와 같다.
MFT 엔트리 첫 번째 필드는 시그니처이고 표준 엔트리는 ASCII 문자열 'FILE'을 가진다.
만약 오류가 있다면 'BAAD' 문자열을 갖는다.
첫번 째 필드에는 엔트리를 사용하는지 엔트리가 디렉토리를 위한 것인지 구분하는 플래그 필드가 있다.
MFT엔트리 할당 상태는 $MFT 파일에 $BITMAP 속성이 결정한다.

파일이 한 개 엔트리 내에서 파일들의 속성을 나타낼 수 없다면 엔트리를 추가한다.
