# 레지스트리

## 개념

- ### 일종의 데이터베이스로 Windows OS의 시스템 정보와 함께 동작에 필요한 다양한 정보들이 기록되어 있습니다. 

## 레지스트리 구조
![RegEdit](https://images.velog.io/images/kmk9502/post/e308efe6-8f0d-4a10-a54f-0cef5f4eeab1/%EB%A0%88%EC%A7%80%EC%8A%A4%ED%8A%B8%EB%A6%AC%20%EA%B5%AC%EC%A1%B0.png)

- ### Key
  - 레지스터에서 폴더처럼 사용하는 개념이다. 폴더에 하위 폴더 및 파일들이 들어갈 수 있듯이 하위 키와 Value(파일과 비슷)를 가질 수 있다. 
- ### Root Key
  - 레지스트리의 최상위 Key. 레지스트리는 총 5개의 Root Key를 갖고 있음
   
    |Root Key|설명| 
    |:------:|:---|
    |HKEY_CLASSES_ROOT|파일 확장자와 확장자가 사용할 프로그램의 매핑 정보가 정의되어 있다. </BR> Ex> .hwp는 한글 워드, .txt는 메모장|
    |HKEY_CURRENT_USER|현재 시스템에 로그온하고 있는 사용자가 설정한 시스템 환경 정보가 정의되어 있다. </BR> Ex> 네트워크, 응용 프로그램 등의 시스템 환경 정보|
    |HKEY_LOCAL_MACHINE|시스템의 하드웨어 구성에 필요한 초기화 파일과 소프트웨어 정보, 드라이버 정보 등이 정의되어 있다.|
    |HKEY_USER|시스템에 있는 모든 계정과 그룹에 대한 시스템 환경 정보가 정의되어 있다. |
    |HKEY_CURRENT_CONFIG|시스템이 부팅 시 사용하는 하드웨어 프로파일 정보가 정의되어 있다. </BR>Ex> 글꼴, 프린터 정보 등의 부가적 정보|
    ||

- ### Value
  - 폴더에 속한 파일처럼 Key 안에 존재한다.

    |Type|Descriprion|Type|Description|
    |:--:|:---------:|:--:|:---------:|
    |REG_SZ|문자열 값|REG_BINARY|이진 값|
    |REG_MULTI_SZ|다중 문자열 값|REG_DWORD|DWORD 값|
    |REG_EXPAND_SZ|확장 가능한 문자열 값|REG_QWORD|QWORD 값|
    ||

- ### Data
  - Value가 가지고 있는 데이터이다. Value의 Type에 따라 문자열 및 이진 값 등을 가질 수 있다.

</br></br>

# Sample 06.exe

## 동작 분석

- ### 1. Sample 06.exe 실행
    ![](https://images.velog.io/images/kmk9502/post/0a461a87-c6cc-4c9c-b161-3ad0ce3c08d2/Sample%2006.exe%20%EC%8B%A4%ED%96%89%20%EA%B2%B0%EA%B3%BC.png)

    - ### 메시지 박스 String 분석
      - 레지스트리가 변경됨
      - 시스템 재부팅을 요구함
- ### 2. 도구를 활용한 API 함수 분석
    ![](https://images.velog.io/images/kmk9502/post/095b1d24-d0e6-483b-af66-272c82963817/RegSetValue%20API%20%EB%B0%9C%EA%B2%AC.png)
    ![](https://images.velog.io/images/kmk9502/post/5a4952f3-85b5-44de-81d7-0bb0813c6390/RegSetValue%20API%20%EB%B0%9C%EA%B2%AC_OllyDbg.png)

    - ### 중요한 API
      - **RegSetValueEx()**
        - 이 API 함수는 레지스트리에 Value 및 Data를 등록하는 함수이다.

- ### 3. 레지스트리 변경 사항 확인
    ![](https://images.velog.io/images/kmk9502/post/898d0950-de26-4917-a36e-391005782aab/%EB%A0%88%EC%A7%80%EC%8A%A4%ED%8A%B8%EB%A6%AC%EC%97%90%20%EB%93%B1%EB%A1%9D%EB%90%9C%20Run_Sample.png)

    Sample 01.exe가 `Run_Sample`이라는 Value의 Data로 등록됨
    - ### 레지스트리 Key : Run 
      - Run은 자신의 내부에 존재하는 Value의 Data를 컴퓨터 부팅과 동시에 실행한다.
      - 악성코드에서 자주 발견되는 Key이다. 

- ### 4. 시스템 재부팅 결과
    ![](https://images.velog.io/images/kmk9502/post/736efd91-a7e3-4eab-9763-eed02bf8e23b/%EB%A9%94%EC%8B%9C%EC%A7%80%20%EB%B0%95%EC%8A%A4%20%ED%81%B4%EB%A6%AD%20%ED%9B%84%20%EC%9E%AC%EB%B6%80%ED%8C%85%20%EA%B2%B0%EA%B3%BC.png)

    - ### 원인
      -  **Run**
         -  Run에 저장된 Value의 Data는 컴퓨터 부팅과 동시에 실행된다.
         -  Sample 06.exe는 Run에 Sample 01.exe 파일을 등록했다.
         -  그래서 재부팅을 함과 동시에 Sample 01.exe가 실행된다.

</br></br>

## Sample 06.exe 파일의 소스코드 분석

- ### 1. 경로 설정
    ```C
    TCHAR	lpRunPath[] = "SOFTWARE\\Microsoft\\windows\\CurrentVersion\\Run";
	TCHAR	lpSamplePath[] = "C:\\Sample 01.exe";
    ```

    - ### lpRunPath[ ]
      - Run Key를 열기 위한 Run 경로이다.
    - ### lpSamplePath[ ]
      - Run에 Data로 등록할 실행 파일의 경로이다.
- ### 2. RegKeyOpenEx()
    ```C
    lResult = RegOpenKeyEx (HKEY_LOCAL_MACHINE,
				lpRunPath, 
				0, 
				KEY_ALL_ACCESS, 
				&hKey);
	if(lResult != ERROR_SUCCESS)
		return 0;
    ```
    - ### 기능
      - Value를 등록, 조회, 수정하기 위해 지정된 레지스트리 Key를 연다.
    - ### 인자 값
      - ### 첫 번째 : HKEY_LOCAL_MACHINE
        - 레지스트리의 Root Key 이름이다. 
        - HKEY_LOCAL_MACHINE 내부의 Key를 열게 된다.
      - ### 두 번째 : lpRunPath
        - (1)에서 경로를 저장하기 위한 배열로 사용되었다.
        - HKEY_LOCAL_MACHINE 내부에 존재하는 Run Key의 경로 값이 저장되어 있다.
      - ### 다섯 번째 : &hKey
        - Key에 대한 핸들 값이다.
        - 운영체제로부터 Key에 대한 권한을 받는 인자이다.
- ### 3. RegEnumValue(), RegDeleteValue()

    ```C
    for (dwCount; lResult == 0x0000 || lResult == 0x00EA; dwCount++)
	{
		lResult = RegEnumValue (hKey, 
					dwCount, 
					lpValue,
					&dwValueSize,
					0, NULL, NULL, NULL);
		
		if(!strcmp(lpValue, "Run_Sample"))
			RegDeleteValue(hKey, lpValue);
	}
    ```

    - ### RegEnumValue()
      - ### 기능
        - Value를 조회하는 함수이다.
        - 주로 특정 Value를 검색하는 데 사용된다.
      - ### 인자 값
        - ### 두 번째 : dwCount
          - 조회하고자 하는 Value의 번호이다.
          - 0부터 증가하면서 특정 Value를 찾을 때까지 반복한다.
          - Sample 06.exe에서 특정 Value란 `Run_Sample`을 의미한다.
        - ### 세 번째 : lpValue
          - 조회한 Value의 이름 정보가 들어간다.
          - 이 인자 값을 찾고자 하는 Value의 문자열 값과 비교하여 파일을 찾는다.
        - ### 여섯 번째 : NULL
          - 조회한 Value의 타입 정보가 들어간다.
          - 필요하지 않다면 NULL 값을 줘도 무방하다.
        - ### 일곱 번째 : NULL
          - 조회한 Value의 Data 값이 들어간다.
          - 필요하지 않다면 NULL 값을 줘도 무방하다.
    - ### RegDeleteValue()
      - ### 기능
        - 지정한 Value를 삭제한다.
      - ### 인자 값
        - ### 두 번째 : lpValue
          - RegEnumValue()가 조회한 Value의 이름 문자열 정보가 저장되어 있다.
          - Sample 06.exe에서는 Run Key 내부에 Run_Sample 존재할 경우 삭제하는 역할로 쓰인다. 
- ### 4. RegSetValueEx()
    ```C
    dwValueSize = (DWORD) strlen(lpSamplePath) + 1;
	
	lResult = RegSetValueEx(hKey, 
				"Run_Sample", 
				0, REG_SZ, 
				(BYTE*)lpSamplePath, 
				dwValueSize);
	if(lResult != ERROR_SUCCESS)
	{
		RegCloseKey(hKey);
		return 0;
	}

    RegCloseKey(hKey);
    ```

    RegSetValueEx()를 사용하기 전에 Sample 01.exe 경로의 길이 값을 dwValueSize에 저장한다.

    - ### 기능
      - 지정된 레지스트리에 Value 및 Data를 등록한다.
    - ### 인자 값
      - ### 두 번째 : "Run_Sample" 문자열
        - 이 문자열은 Run Key에 등록할 Value의 이름이다.
        - (4)를 통해서 추가로 알 수 있는 것 
          - (3)은 "Run_Sample"이라는 Value을 등록하기 전에 이와 같은 이름을 지닌 Value가 존재한다면 삭제하는 기능이다.
       - ### 다섯 번째 : (BYTE*)lpSamplePath
         - (1)에서 저장했던 `Sample 01.exe`가 존재하는 경로이다.
         - 이 인자 값은 Value(Run_Sample)의 Data 값으로 등록된다. 
         - (4)를 통해 알 수 있는 것
           - (4)의 두 번째 인자 값은 Run Key 내의 Value 이름을, 다섯 번째 인자 값은 그 Value의 Data 값을 의미한다.

- ### 5. MessageBox(), WinExec()

    ```C
    MessageBox(NULL, "The registration has been completed.\nComputer Reset START!!", "RegEdit", MB_OK);
	
	WinExec("cmd.exe /C shutdown -r -f -t 0", SW_HIDE);

	return 1;
    ```

    - ### MessageBox()
      - ### 기능
        - 메시지 박스를 출력한다.
      - ### 인자 값
        - ### 두 번째 문자열
          - 메시지 박스에 본문으로 출력되는 문자열이다.
        - ### 세 번째 문자열
          - 메시지 박스의 제목으로 출력되는 문자열이다.
        - ### 네 번째 : MB_OK
          - 메시지 박스의 `OK` 버튼을 출력한다.
    - ### WinExec()
      - ### 기능
        - 지정된 애플리케이션을 실행한다.
      - ### 인자 값
        - ### 첫 번째 : "cmd.exe /C shutdown -r -f -t 0"
          - cmd.exe를 실행하여 `/C shutdown -r -f -t 0` 명령어를 입력한다.
          - `/C shutdown -r -f -t 0` 명령어는 컴퓨터 재부팅 명령어이다.
        - ### 두 번째 : SW_HIDE
          - 표시 옵션이다.
          - `SW_HIDE`의 경우, 지정된 애플리케이션 창을 숨기고 다른 창을 활성화하는 인자 값이다.