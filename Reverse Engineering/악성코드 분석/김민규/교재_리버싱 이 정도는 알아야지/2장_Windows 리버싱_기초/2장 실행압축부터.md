# 실행 압축

## 실행 압축 이해

- ### **정의**
  - 실행 압축은 PE 파일이 실행 가능하도록 압축된 형태이다. 
- ### **실행 압축 특징**
  - 일반 압축은 사용자가 직접 압축 도구를 설치해 사용해서 압축을 해제해야 한다. 반면, 실행 압축된 PE 파일은 동작 과정에서 자동으로 압축이 해제된다. 즉, 별도의 압축 도구 없이 PE 파일을 실행시키면 압축이 해제된다.
  - 실행 압축된 파일 내부에는 **압축된 데이터와 압축 해제 코드**가 있다. 파일을 실행하면 압축 해제 코드가 동작하면서 압축 해제가 자동으로 이루어진다.
- ### **실행 압축 활용**
  - ### 의문
    - 실행 압축은 무엇을 위한 압축인가?
  - ### 답
    - 실행 압축 개발 초기에는 컴퓨터의 저장공간과 메모리가 지금과 비교해서 매우 작았었다. 따라서 PE 파일의 크기를 줄이고자 하는 목적으로 개발되었다.
    - 현재는 파일 크기의 최소화보다는 PE 파일 내부 코드와 리소스(문자열, API 등)를 감추기 위한 목적을 중점으로 사용된다.
    - 예를 들어 리버싱 및 디버깅을 막기 위해 더미코드를 삽입하는 등 안전장치를 거는 목적으로 활용된다.
- ### **Unpacking 과정**
  - ### 정의
    - Packing. 즉, 실행 압축 상태를 해제하는 것을 Unpacking이라고 한다.
  - ### 압축 해제 과정
    - 1. 압축되어 있는 데이터를 읽어와서 압축 해제 후 메모리에 기록한다.
    - 2. 압축 해제가 완료되면 CALL이나 JMP 주소를 복원한다.
    - 3. IAT를 복구한다.
    - 4. OEP(명령어 시작 주소)로 이동한다.

</br></br>

## UPX로 실행 압축된 파일 살펴보기

- ### UPX로 실행 압축된 파일과 원본 파일 비교

    ![UPX 포멧 비교](http://2.bp.blogspot.com/-LVau7zWf-qo/Uv4B_h9HjoI/AAAAAAAAAE8/WUu4f2PDJiU/s1600/UPX.png) 

  - ### UPX1
    - 실행 파일의 압축된 코드와 데이터, 압축 해제 코드가 UPX1 섹션에 기록되어 있다.
    - 압축된 파일을 실행할 때 제일 먼저 압축 해제 코드가 동작해야 하기 때문에 **EP**가 RECOVERY CODE. 즉, 압축 해제 코드가 존재하는 곳을 가리킨다.
  - ### UPX0
    - 압축 해제된 데이터를 기록하기 위해 만들어놓은 섹션이다.
    - UPX1 섹션의 데이터가 압축 해제될 때마다 순서대로 UPX0에 저장된다.
  - ### UPX0 정리
    - 1. UPX로 실행 압축된 파일이 실행
    - 2. EP가 가리키는 압축 해제 코드가 동작하면서 압축된 데이터를 UPX0 섹션에 기록
    - 3. 압축 해제 과정이 완료되면 코드 흐름이 UPX0로 옮겨진 OEP 코드로 이동하면서 본래의 기능을 수행

</br></br>

## UPX Unpacking 

- ### 재료
  - Sample 04.exe

</br>

- ### 1. OEP(코드 시작점) 찾기

    ![](https://images.velog.io/images/kmk9502/post/4e128997-ac85-4bd5-9e3b-9da5c2abaa1f/%EC%95%95%EC%B6%95%20%EB%8D%B0%EC%9D%B4%ED%84%B0%20%EB%B0%8F%20%EC%95%95%EC%B6%95%20%ED%95%B4%EC%A0%9C%20%EB%8D%B0%EC%9D%B4%ED%84%B0%20%EC%A0%80%EC%9E%A5%20%EC%A3%BC%EC%86%8C.png) 

    - **압축된 데이터 저장 주소**
      - ESI = 0x00408000
    - **압축 해제된 데이터 저장 주소**
      - EDI = 0x00401000
- ### 2. 각 주소의 데이터 값 확인

    ![](https://images.velog.io/images/kmk9502/post/d3d3ce6e-46a1-42b2-ab70-5f4ae0374ab4/00408000.png)

    ![](https://images.velog.io/images/kmk9502/post/eabf700a-969a-4bdf-bc8c-04ddd9ed0b2d/00401000.png)

    - 현재 압축된 상태이므로 0x00408000 주소에 압축된 데이터가 저장되어 있다. 
    - 압축 해제 과정에서 0x00408000 주소에 저장된 값을 읽어와서 적절한 연산을 거쳐서 압축을 해제한 뒤에 UPX0(0x00401000) 영역에 쓴다.
- ### 3. 압축 해제 루틴 확인

    ![](https://images.velog.io/images/kmk9502/post/da03823b-81a4-426c-a852-2f37751f2b6c/%EC%95%95%EC%B6%95%20%ED%95%B4%EC%A0%9C%20%EB%B0%98%EB%B3%B5%EB%AC%B8.png)
    
    <반복문 시작 지점>

    ![](https://images.velog.io/images/kmk9502/post/0509928b-82e1-4dc4-a41b-45a3bf235b9c/%EC%95%95%EC%B6%95%20%ED%95%B4%EC%A0%9C%20%EB%B0%98%EB%B3%B5%EB%AC%B8%20%EB%81%9D%EC%A7%80%EC%A0%90.png)

    <반복문 끝지점>

    - **반복문 루틴 파악**
      - 반복문 시작 지점을 보면 압축된 데이터가 저장된 ESI(0x00408000)에서 byte만큼의 값을 AL로 가져와 압축 해제 데이터가 저장되는 EDI(0x00401000)에 저장한다. 그리고 INC 명령어를 사용해 주소값을 1 증가시켜 다음 데이터를 압축 해제할 준비를 한다.
      - ESI의 데이터를 EDI에 바로 기록하기도 하고, JCC 명령어를 거쳐 특정 연산 후에 기록하기도 한다.
- ### 4. 압축 해제 데이터 확인
    
    ![](https://images.velog.io/images/kmk9502/post/6831be8c-b09d-4b70-a749-75c5060737af/%EC%95%95%EC%B6%95%20%ED%95%B4%EC%A0%9C%20%ED%9B%84%20401000.png)

    ![](https://images.velog.io/images/kmk9502/post/625f669b-e617-408e-a6a0-938d3d6c8c93/%EC%95%95%EC%B6%95%20%ED%95%B4%EC%A0%9C%20%ED%9B%84%20408000.png)

    - 0x00401000 주소에 압축 해제된 데이터가 모두 저장된 모습이다. 
- ### 5. CALL, JMP 복원 루틴
    
    ![](https://images.velog.io/images/kmk9502/post/ef75fa2a-117a-4465-84a2-b8daeab64a47/CALL,%20JMP%20%EB%B3%B5%EC%9B%90%20%EB%A3%A8%ED%8B%B4.png)

    - 0x0040A877 주소부터 0x0040A87E 주소까지 CMP와 JCC 명령어를 통해 CALL, JMP를 복원하는 데 필요한 무언가를 찾는 모습이 보인다.
- ### 6. IAT 복원 루틴
    
    ![](https://images.velog.io/images/kmk9502/post/7e05e1de-32a3-4927-bb4e-4144f939b761/IAT%20%EB%B3%B5%EA%B5%AC_LoadLibraryA.png)
    <LoadLibraryA() 함수 호출>

    ![](https://images.velog.io/images/kmk9502/post/93fbf6b9-b77e-4f3c-b560-d10a28aafa1e/IAT%20%EB%B3%B5%EA%B5%AC_GetProcAddress.png)
    <GetProcAddress() 함수 호출>

    ![](https://images.velog.io/images/kmk9502/post/32b512f2-3058-4e12-bb35-980b6e14c37e/IAT%20%EB%B3%B5%EA%B5%AC_.png)
    <IAT 복원>

    ![](https://images.velog.io/images/kmk9502/post/1ae213b0-eefc-4259-bc4e-d92650c0ce70/IAT%20%EB%B3%B5%EA%B5%AC%20%EC%9D%B4%ED%9B%84%20OEP%20%EC%9D%B4%EB%8F%99.png)
    <압축 해제 완료 후 복원된 파일의 OEP 주소로 JMP>

    ![](https://images.velog.io/images/kmk9502/post/46f4aabd-e634-43ed-9661-b2a93b7259de/OEP%20%EB%8F%84%EC%B0%A9.png)

    <압축 해제된 파일의 OEP(Stub 코드 시작점)>

    - **LoadLibraryA(), GetProcAddress()**
      - 이 두 함수는 프로세스에서 호출하는 API 함수 주소를 알아내고 IAT 영역에 기록하는 코드로 구성되어 있다. 즉, IAT를 복원하는 함수로 사용된다.
      - <IAT 복원> 사진에서 보이는 0x0040A8D9는 함수 주소를 IAT에 기록하는 코드이다. 즉, EBX 레지스터에는 IAT의 위치 주소가 기록되어 있다.