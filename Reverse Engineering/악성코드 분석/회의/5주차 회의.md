# 5주차 회의

## 주제
- ### Lena Tutorial : Lena 1 문제 해결 과정
- ### Lena Tutorial : Lena 3 문제 해결 과정

</br></br>

## 참여인원
- ### 김민규, 이재용
 
  ![](https://images.velog.io/images/kmk9502/post/86e6e5a8-3141-4f39-8429-5ee5e341731d/%ED%9A%8C%EC%9D%98%20%EC%B0%B8%EC%97%AC%EC%9E%90%20%EB%AA%85%EB%8B%A8_5%EC%A3%BC%EC%B0%A8.png)

# Lena 1

## 목적

- ### 적절한 Key 파일을 만들어 성공 메시지 박스를 출력하라.

## 문제

- ### Lena 1번 실행파일의 초기 실행에서 오류 메시지 박스가 출력됨


## 해결

![](https://images.velog.io/images/kmk9502/post/0fc0519f-bcaa-450a-9227-60856392552c/%EC%84%B1%EA%B3%B5%20%EC%A1%B0%EA%B1%B4%201.png)

- ### 해결 방법
  - 401078과 40107B는 Lena 1 프로그램이 위치한 경로에 `Keyfile.dat`이라는 파일이 존재하는지 검사한다. 
  - 따라서 해당 경로에 Keyfile.dat 파일을 생성한다.

![](https://images.velog.io/images/kmk9502/post/a8bbbea0-d301-427f-8afe-591c138ea1c4/%EC%84%B1%EA%B3%B5%20%EC%A1%B0%EA%B1%B4%202.png)

- ### 해결 방법
  - JCC 명령어와 CMP 비교 명령어를 분석한 결과, 3가지 조건을 발견할 수 있었다.
  - 1. Keyfile.dat 파일의 내용은 16자 이상이어야 한다.
  - 2. `G` 문자가 포함되어야 한다.
  - 3. `G` 문자는 8자 이상이어야 한다.
  - 3가지 조건에 맞추어 Keyfile.dat의 내용을 작성한다. 

![](https://images.velog.io/images/kmk9502/post/abf19ab3-9bf5-4fc5-bcd0-54979a6c4c99/Keyfile%20%EB%82%B4%EC%9A%A9.png)

<올바른 Key 파일의 내용>

![](https://images.velog.io/images/kmk9502/post/9946ee04-0c93-4c70-8995-db243dfd9cc7/%EB%AA%A9%ED%91%9C%20%EB%8B%AC%EC%84%B1.png)

<성공 메시지 박스 출력 성공>

</br></br>

# Lena 3

## 목적

- ### exe 파일을 수정하여 메시지 박스 출력을 막아라

## 문제

- ### Lena 3번 초기 실행에서 메시지 박스 1 -> 메시지 박스 2 -> 메시지 박스 3, 총 3개의 메시지 박스가 출력됨. 이중, 메시지 박스 2를 제외한 나머지는 필요 없음

![](https://images.velog.io/images/kmk9502/post/b54703a4-ecf8-4ac6-9961-7e438bb72d8b/%EC%9B%90%EB%B3%B8%20%ED%8C%8C%EC%9D%BC.png)
<원본 파일>

## 해결

### 1) 메시지 박스 회피 및 무시

![](https://images.velog.io/images/kmk9502/post/ba00f894-8205-44fa-a933-c84a890ad522/%EB%AC%B8%EC%A0%9C%20%ED%95%B4%EA%B2%B0%201.png)

- ### 해결 방법
  - 0x0040100F 주소의 JCC 명령어의 점프 조건을 바꾸어 첫 번째 메시지 박스 출력을 회피
  - 두 번째 메시지 박스 함수인 401039 ~ 401047 주소를 모두 NOP으로 치환하여 무시

### 2) 메시지 박스 출력 권한 재설정

![](https://images.velog.io/images/kmk9502/post/eda51db6-5e8b-4912-afb2-22eec27e89e6/%EB%AC%B8%EC%A0%9C%20%ED%95%B4%EA%B2%B0%202.png)

- ### 해결 방법
  - 40101D와 401045 주소에서 PUSH로 전달되는 핸들값을 임의의 값 1로 치환한다.
  - ### 핸들값이 0일 때
    - 메시지 박스를 출력할 윈도우의 핸들값이 존재하지 않는 상태. </br>즉, 메시지 박스의 주인이 없기 때문에 독립적으로 출력 가능한 상태이다.
  - ### 핸들값이 존재할 때
    - 해당 메시지 박스를 출력할 윈도우의 핸들값이 존재한다는 의미이며 보통 윈도우의 핸들값이 저장된 버퍼를 참조한다. </br>이곳에 의미 없는 임의의 숫자(Ex> 1)를 넣어주면 메시지 박스를 출력할 윈도우는
	없지만, 메시지 박스는 독립적으로 출력할 수 없게 된다. 따라서 메시지 박스는 출력되지 않는다.

### 3) 코드 시작점 변경 및 권한 재설정

![](https://images.velog.io/images/kmk9502/post/b8ae598d-0f3e-40a8-a3ff-2d78a6d9758e/%EB%AC%B8%EC%A0%9C%20%ED%95%B4%EA%B2%B0%203.png)
![](https://images.velog.io/images/kmk9502/post/86db6313-eec9-4f71-91e2-4e4b69314bb2/%EB%AC%B8%EC%A0%9C%20%ED%95%B4%EA%B2%B0%203_%EB%A9%94%EB%AA%A8%EB%A6%AC%20%EB%8D%A4%ED%94%84%EA%B0%92%20%EB%B3%80%EA%B2%BD.png)

![](https://images.velog.io/images/kmk9502/post/465cfebd-752f-44ac-93f7-e993d893c58c/%EB%AC%B8%EC%A0%9C%20%ED%95%B4%EA%B2%B0%203_PE%20%EB%82%B4%EC%9A%A9%20%EB%B3%80%EA%B2%BD.png)

- ### 해결 방법
  - OllyDbg의 메모리 덤프에서 4000E8 주소에 존재하는 Address of Entry Point. 즉, 코드 시작점을 </br>기존 1000에서 1024로 치환하여 첫 번째 메시지 박스 함수를 회피한다. 
  - 401045 주소에서 PUSH 값으로 전달되는 핸들값을 임의의 값 1로 치환하여 메시지 박스가 독립적으로 출력되지 못하게 한다.