# 패킹된 DLL의 DllMain() 찾기

## DllMain()을 찾을 수 있는 패킹 환경

패커의 종류는 매우 다양하다. 그중에서 패킹상태에서 DllMain()을 찾을 수 있는 패커는 코드 자체를 변경하지 않고 단지 위치만 변경하는 패커이다. 그 이유는 휴리스틱 패턴 기법을 응용하여 DllMain()을 찾을 것이기 때문이다.

- ### UPX
- ### 더미다(Themida) ; 코드 변경 없이 더미코드만 집어넣는 더미다일 경우
 
## 휴리스틱 패턴 기법을 응용한 DllMain() 찾기

- ### 휴리스틱 패턴(heuristic pattern) 기법이란?
  - 특정 기능을 구현하기 위해서는 특정 코드를 사용할 수밖에 없기 때문에 그 패턴을 찾아서 해당 코드의 존재 여부를 파악하는 방법이다.
  - 바이러스가 자주 사용하는 중요 패턴을 백신에 포함시켜 놓고 그 패턴을 보유한 파일을 찾는 방법을 활용한 것이다.

- ### 휴리스틱 패턴 기법을 응용한 DllMain() 찾기 예시

    - 개발자는 DllMain()을 작성할 때 Switch case 문을 먼저 작성할 것이므로 아래의 어셈블리 코드가 생성될 것이다.

            CodeAddress    8B 44 24 08    mov eax, [esp+8]          ; case 값을 eax에 저장
            CodeAddress    83 E8 00       sub eax, 0
            CodeAddress    74 2A          jE short loc_CodeAddress  ; case 값이 0일 때 점프

    - 위의 코드는 DllMain()에 Switch case 문을 작성할 때 **공통적으로 나타나는 코드**이다. 즉, 이 코드의 패턴을 검색해서 해당 코드의 존재 유무를 파악할 수 있다.
    - 위의 코드의 옵코드 형식을 모아서 OllyDbg의 CPU 창에 오른쪽 버튼을 누른 뒤 Search for Binary String 메뉴를 띄운 후 HEX 칸에 모아둔 옵코드를 입력하고 검색하면 DllMain()에서 위의 코드가 존재한다면 해당 코드를 볼 수 있다.
    - 옵코드를 모을 때 2A와 같은 값은 포함시키지 않아야 한다. 그 이유는 **DLL의 재배치** 특성 때문이다. 
      - DLL은 메모리에 로딩될 때마다 위치가 바뀔 수 있는 유동적인 특성이 있다. 위치가 바뀌면 DLL 안에서 참조하는 메모리 주소도 같이 바뀌기 때문에 메모리 주소 인자의 옵코드 2A는 포함하면 안된다.
- ### 휴리스틱 패턴 기법이 통하지 않는 패킹 환경
  - UPX나 Themida 같이 코드를 변경하지 않는 패커는 옵코드도 변경되지 않아 해당 기법을 사용해 DllMain()을 찾을 수 있지만, 코드를 변경하는 패커나 프로덱터가 적용된 파일은 코드가 변경됨과 동시에 옵코드도 변경되어 해당 기법을 사용할 수 없다. 