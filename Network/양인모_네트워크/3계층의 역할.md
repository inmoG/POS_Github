# 3계층의 역할

세그먼트 내에서 데이터의 송수신을 하는 것이 2계층의 역할이다. 3계층은 라우터와 라우터간의 범위로 네트워크와 네트워크를 연결해 다른 네트워크에 있는 컴퓨터끼리 데이터 통신이 가능하다.

## 네트워크

라우터 내의 컴퓨터 그룹 범위를 네트워크라 정의한다. 허브, 스위치는 네트워크를 나누지 않는다. 라우터와 라우터 사이 포인트 투 포인트 네트워크도 "네트워크"이다.

### 네트워크를 나누는 이유

스위치로 구성된 네트워크에서는 1대가 송신한 브로드캐스트가 모든 컴퓨터에 도달한다. 라우터는 브로드캐스트를 중계하지 않는다. 라우터를 넘어서는 브로드캐스트는 전송되지 않는다.
PC가 브로드캐스트를 자주 처리하는 건 자원낭비이다. 따라서 브로드캐스트가 도달하는 범위를 한정해서 브로드캐스트 문제를 해결해야 한다.

## 라우팅

라우터는 목적지까지의 경로 중 최적의 경로를 찾아 데이터를 보낸다.

### IP

IP는 네트워크 내에서 유일해야 한다.

#### IP헤더

수신처 송신처의 IP주소와 라우팅에서 사용하는 값 등이 있다.

#### 클래스

IP주소를 조직의 규모에 따라 A ~ E로 나누고 그 범위의 주소를 할당한다. 호스트 번호 모두가 0 이면 네트워크 자체를 표시하고 모두 1 이면 브로드캐스트 주소를 의미한다. 네트워크 주소, 브로드캐스트 주소는 할당할 수 없다.

##### 서브넷

네트워크를 여러 개의 네트워크로 분할한 네트워크

##### 클래스리스 어드레싱

클래스 구분을 없앤 주소할당 방식이다. 현재는 IP 낭비가 없고 편리해 클래스리스 어드레싱 방식을 사용한다.

###### 클래스플 어드레싱 문제점

클래스에 딱 맞지 않으면 사용하지 않는 IP주소가 생긴다.

## DHCP

IP 주소 할당방식은 정적방식과 동적방식이 있다. 정적방식은 네트워크 관리자가 지정한 IP를 할당한다. 동적방식은 DHCP 서버를 사용해 할당 주소범위 내에서 자동으로 IP를 할당한다. 이 서버는 할당할 IP 주소를 관리하고 할당 작업을 수행하는 서버와 할당 받는 클라이언트로 구성된다.

### 할당방식

1. DHCP 클라이언트는 IP주소를 요청한다.
2. IP주소 범위에서 사용되고 있지 않은 주소를 선택한다.
3. IP주소를 대여한다.

#### DHCP 패킷

`이더넷 헤더 | IP 헤더 | UDP 헤더 | DHCP 메시지`

##### DHCP 메시지

1. 오퍼레이션 코드
2. 클라이언트 IP주소 : 현재의 클라이언트 주소

3. 할당 IP주소 : 서버가 할당한 주소
4. 서버 IP 주소
5. 클라이언트 MAC주소
6. 옵션

   메시지 타입 : DISCOVER, OFFER, REQUEST, ACK

   클라이언트 설정 : 서브넷마스크, 디폴트게이트웨이, DNS서버주소, 대여기간 등

##### DHCP 동작

IP주소와 서브넷마스크, 디폴트 게이트웨이, DNS서버, 대여기간 등을 보낸다.
컴퓨터가 켜진 시점에서 클라이언트는 어디로 메시지를 보내야 되는지 몰라 브로드캐스트한다.

1. DHCP 클라이언트는 DHCP DISCOVER 메시지를 브로드캐스트한다.
2. DISCOVER를 받은 서버는 할당할 IP주소를 IP주소 풀(할당 가능 범위)에서 선택해 클라이언트에게 OFFER메시지를 브로드캐스트한다.
3. 클라이언트는 OFFER에서 받은 IP주소가 문제 없다면 DHCP REQUEST를 서버에 브로드캐스트한다.
4. REQUEST를 받은 서버는 문제가 없으면 서브넷마스크 등 옵션설정을 DHCP ACK에 넣어서 보낸다.

## ARP

수신처 IP주소에 대응한 MAC 주소를 얻기위해 브로드캐스트한다.

### 동작

1. 송신 컴퓨터는 먼저 자신의 ARP 테이블을 참조한다.
2. ARP 테이블에 수신처 IP주소가 없을 경우 ARP 요청을 브로드캐스트한다.
3. 자신의 IP와 동일한 컴퓨터는 ARP 요청에 응답한다. 그렇지 않은 경우는 파기한다.
4. ARP 응답을 받으면 ARP 테이블에 응답 결과를 작성한다.

#### ARP 파기 이유

인터페이스 고장 등으로 MAC 주소가 변경되었지만 ARP 테이블의 주소를 파기하지 않는다면 잘못된 주소로 전송해 패킷이 목적지에 도착하지 않는다.

## DNS

도메인 명과 IP주소를 대응시킨 시스템

전 세계의 도메인 명, 호스트 명을 관리하는 분산형 데이터베이스

### 동작

1. 사용자는 네이버 도메인 `www.naver.com`에 접속한다.
2. DNS 서버에 `www.naver.com`에 대응하는 IP 주소를 문의한다.
3. DNS 서버는 문의한 도메인 명에 대응하는 IP 주소를 DB에서 찾는다.
4. 도메인 명에 대응한 IP주소를 응답한다.

#### 찾지 못할 경우

1. 사용자는 구글 도메인 `www.google.com`에 접속한다.
2. DNS 서버에 `www.google.com`에 대응하는 IP 주소를 문의한다.
3. DNS 서버는 IP를 찾지 못해 구글의 DNS 서버에 문의한다.
4. 구글 DNS 서버는 문의한 도메인 명에 대응하는 IP 주소를 DB에서 찾는다.
5. 구글 DNS 서버는 도메인 명에 대응한 IP주소를 응답한다.
6. DNS 서버는 도메인 명에 대응한 IP 주소를 응답한다.

# 통신 흐름

1. 자신의 IP 주소는 수동 또는 DHCP에서 할당 받고 MAC 주소는 NIC를 확인한다.
2. `www.google.com`에 접속하기 위해 DNS에 IP를 문의한다.
3. 구글 도메인의 IP를 얻는다.
4. ARP로 게이트웨이(라우터)의 MAC 주소를 얻는다.
5. 게이트웨이(라우터)는 다음 라우터의 IP를 알고 있어 ARP를 보낸다. 이 때 송신자 MAC 주소는 게이트웨이의 MAC주소로 변경된다.
6. ARP로 다음 라우터의 MAC 주소를 얻는다.
7. 5번 6번을 반복해 구글 서버의 라우터까지 패킷이 이동한다.
8. 라우터는 수신자 IP의 주인을 찾기 위해 ARP를 보낸다.
9. 해당하는 IP를 가진 서버는 MAC 주소를 전달한다.
10. MAC 주소를 확인 후 해당 서버에게 패킷을 전달한다.
